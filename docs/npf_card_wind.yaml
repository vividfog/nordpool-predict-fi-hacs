type: custom:apexcharts-card
header:
  show: true
  title: Tuulivoima- ja hintaennuste
  show_states: false
  colorize_states: true
  standard_format: false
  disable_actions: true
graph_span: 7d
experimental:
  color_threshold: true
span:
  start: hour
now:
  show: false
  color: "#1c88fb"
  label: Nyt
series:
  - entity: sensor.nordpool_predict_fi_upcoming_wind_power
    name: Tuulivoima, GW
    type: line
    yaxis_id: wind
    extend_to: now
    curve: stepline
    stroke_width: 1.5
    float_precision: 2
    color: skyblue
    opacity: 1
    color_threshold:
      - value: 0.5
        color: red
        opacity: 0.8
      - value: 1
        color: skyblue
        opacity: 0.8
      - value: 2
        color: deepskyblue
        opacity: 0.8
      - value: 3
        color: dodgerblue
        opacity: 0.8
      - value: 4
        color: blue
        opacity: 0.8
      - value: 5
        color: mediumblue
        opacity: 0.8
      - value: 6
        color: darkblue
        opacity: 0.8
      - value: 7
        color: midnightblue
        opacity: 0.8
    data_generator: |
      const data = entity.attributes.windpower_forecast || [];
      return data.map((item) => [item.timestamp, item.value / 1000]);
    show:
      in_legend: true
      legend_value: false
  - entity: sensor.nordpool_predict_fi_upcoming_price
    name: Senttiä per kWh
    type: column
    yaxis_id: price
    float_precision: 1
    color: "#c7ced6"
    opacity: 0.35
    extend_to: now
    stroke_width: 0
    data_generator: |
      const data = entity.attributes.forecast || [];
      return data.map((item) => [item.timestamp, item.value]);
    show:
      in_legend: true
      legend_value: false

  # This is a VAT 25.5% sensor; replace with your own if needed, note tax rate calculation below
  - entity: sensor.nordpool_kwh_fi_eur_3_10_0255
    name: Nordpool toteutunut
    yaxis_id: price
    type: column
    group_by:
      func: avg
      duration: 1h
    float_precision: 1
    stroke_width: 0
    color: "#c7ced6"
    opacity: 0.35
    fill_raw: "null"
    unit: ¢/kWh
    show:
      in_header: false
      legend_value: false
    data_generator: |
      return [...entity.attributes.raw_today.map((start, index) => {
                // For VAT zero sensor replace 100 with 125.5 to match net price scaling
                return [new Date(start["start"]).getTime(), entity.attributes.raw_today[index]["value"]*100];
             }),
             ...entity.attributes.raw_tomorrow.map((entry) => {
                // For VAT zero sensor replace 100 with 125.5 to match net price scaling
                return [new Date(entry.start).getTime(), entry.value*100];
             }),
             // Add a new entry for the day after tomorrow with a zero value
             [new Date(new Date().setDate(new Date().getDate() + 2)).setHours(0, 0, 0, 0), 0]
             ].filter(([timestamp, _]) => {
                 const now = new Date();
                 const endOfDayAfterTomorrow = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 3);
                 endOfDayAfterTomorrow.setHours(0, 0, 0, 0); // Set to the beginning of the day after tomorrow
                 return timestamp < endOfDayAfterTomorrow.getTime();
             });
  - entity: sensor.nordpool_predict_fi_upcoming_wind_power
    type: area
    yaxis_id: wind
    extend_to: now
    curve: stepline
    stroke_width: 0
    float_precision: 1
    color: skyblue
    opacity: 0.16
    data_generator: |
      const data = entity.attributes.windpower_forecast || [];
      return data.map((item) => [item.timestamp, item.value / 1000]);
    show:
      in_chart: true
      in_header: false
      in_legend: false
      legend_value: false
yaxis:
  - id: wind
    min: 0
    decimals: 1
    apex_config:
      tickAmount: 5
      title:
        text: Tuulivoima (GW)
  - id: price
    opposite: true
    decimals: 0
    apex_config:
      tickAmount: 4
      forceNiceScale: true
      title:
        text: Hinta (¢/kWh)
apex_config:
  chart:
    toolbar:
      show: false
  theme:
    mode: light
  grid:
    strokeDashArray: 3
    xaxis:
      lines:
        show: true
  legend:
    show: true
    customLegendItems:
      - Tuulivoima (GW)
      - Ennustettu hinta (¢/kWh)
  xaxis:
    type: datetime
    labels:
      datetimeFormatter:
        day: dd MMM
  markers:
    size: 0
